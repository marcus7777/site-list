<link rel="import" href="../get-hash/get-hash.html">
<link rel="import" href="../paper-filter/paper-filter.html">
<link rel="import" href="../get-geo-data/get-geo-data.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../paper-material/paper-material.html">
  
<dom-module id="site-list">
  <style>
    :host {
      display: block;
      text-align: center;
    }
    paper-button {
      background: #fff;
      min-width: 172px;
      margin: 0px 2px 6px;
      font-family: Roboto, Helvetica, sans-serif;
      font-weight: 300;
    }
    paper-material {
      margin: 16px, 16px;
      height: 100px;
      min-width:360px;
      margin:10px;
      display: inline-block;
      background: #fff;
      font-family: Roboto, Helvetica, sans-serif;
      font-weight: 300;
    }
    a:link {
      color:black;
    }
    google-map {
      height: 300px;
    }
  </style>
  
  <template>
    
    <h2>{{_search}}</h2>
    
    <get-hash location="{{_search}}" map="{{map}}" hash="{{hash}}"></get-hash>
    
    <google-map hidden="{{!_search}}}" map="{{map}}" id="map">
     <!-- <template is="dom-if" if="{{showingMap}}"> -->
        <template is="dom-repeat" items="{{data_by_tf}}" as="marker">
          <google-map-marker icon="{{marker.type}}.svg" longitude="{{LatLngTolongitude(marker.LatLng)}}" latitude="{{LatLngTolatitude(marker.LatLng)}}" title="{{marker.value}}" >
            <a href="{{marker.url}}">
              <h4>{{marker.value}}</h4>
              <img src="{{ addCDN('https://sdyrcs.cloudimage.io/s/crop/120x120/', marker.image) }}">
            </a>
          </google-map-marker>
        </template>
      <!-- </template> --> 
    </google-map>

    <get-geo-data
       location="https://essential-map.firebaseio.com/geo"
       geo="{{hash}}" 
       data="{{data}}" >
    </get-geo-data>
    
    <paper-filter hidden="{{!_search}}}" by="type,facilities" data="{{data}}" output="{{data_by_tf}}" top_filter="{{top_filter}}"></paper-filter>
    
    <template is="dom-repeat" items="{{output}}" as="card" id="cards" delay="400">
      <a href="{{card.url}}" title="{{card.value}}" >
        <paper-material>
          <div class="body1" style="float: left;width:250px">
            <h3>{{card.value}}</h3>
            <span>{{card.title}}</span>
            <span>more infomation</span>
          </div>
          
          <!-- <iron-image sizing="cover" src="https://sdyrcs.cloudimage.io/s/crop/120x120/{{card.image}}" style="width:100px; height:100px;"></iron-image> -->
          <iron-image sizing="cover" src="{{card.image}}" style="float: right;width:100px; height:100px;"></iron-image>
        </paper-material>
      </a>
    </template>
  </template>
</dom-module>
<script type="text/javascript">
    Polymer({
      is: 'site-list',
      properties: {
        output: {
          type: Array,
          computed: 'byCenter(data_by_tf,hash,30)'
        },
        search: {
          type: String,
          value:"nOrTh PoLe"
        },
        debounceing: {
          computed: 'debounceInput(search)'
        },
        hash: {
          type:String,
          value:"gzzzzzzzzzzz"
        },
        top_filter: {
          type:Array,
          notify: true
        }
      },
      debounceInput: function(data) {
        this.debounce("setInput", this.setInput, 800)
      },
      setInput: function(){
        this._search = this.search;
      },
      byCenter: function(data, center) {
        if (this.search != "nOrTh PoLe") {
          return byCenter(data, center, 20);
        }
      },
      LatLngTolongitude: function(value) {
        if (value !== undefined) {
          return +value.split(',')[1];
        }
      },
      LatLngTolatitude: function(value) { console.log('LatLngTolatitude');
        if (value !== undefined) {
          return +value.split(',')[0];
        }
      },
      addCDN: function(cdn, url) {
        return cdn + url;
      },
      ready: function() {
        setInterval(function() {       
          var app = document.querySelectorAll('html site-list')[0];
//          app.output = byCenter(app.data_by_tf, app.hash, 20);
          document.querySelector('google-map').resize();
          this.showingMap = true
          app.$.cards.render();
        },3000)
      }
    });
</script>
